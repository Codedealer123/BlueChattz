<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web Game IDE (HTML Version)</title>
  <style>
    :root{ --border: rgba(255,255,255,.08); }
    body { margin:0; font-family: sans-serif; background:#0b0d12; color:#eee; height:100vh; display:flex; flex-direction:column; }
    header { display:flex; align-items:center; justify-content:space-between; background:#111827; padding:0.5rem 1rem; position:sticky; top:0; z-index:5; border-bottom:1px solid var(--border); }
    header h1 { margin:0; font-size:1rem; }
    .btn { background:#18b27a; color:#fff; border:none; border-radius:6px; padding:0.45rem 0.75rem; cursor:pointer; }
    .tabs { display:flex; border-bottom:1px solid var(--border); background:#0e1220; }
    .tab { flex:1; text-align:center; padding:0.55rem; cursor:pointer; background:#121827; color:#aab2c6; font-weight:600; }
    .tab.active { background:#1f2435; color:#fff; }
    .panels { flex:1; display:flex; flex-direction:column; min-height:0; }
    .panel { flex:1; display:none; min-height:0; }
    .panel.active { display:flex; flex-direction:column; min-height:0; }
    textarea { flex:1; width:100%; resize:none; border:none; outline:none; padding:0.75rem; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:13px; background:#0b0d12; color:#eee; }

    /* Preview layout with responsive scaling */
    .stage { position:relative; flex:1; min-height:0; background:#0f1117; display:grid; place-items:center; border-bottom:1px solid var(--border); overflow:hidden; }
    .stage-inner { position:relative; width:100%; height:100%; display:grid; place-items:center; }
    iframe#preview { position:absolute; top:0; left:0; transform-origin: top left; border:none; background:#0b0d12; box-shadow: 0 16px 40px rgba(0,0,0,.45); outline:1px solid var(--border); }

    .console { background:#000; color:#d1fae5; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; height:140px; overflow:auto; padding:0.5rem; }
    .log-err{ color:#f87171; }
    .toolbar-right { display:flex; gap:.5rem; align-items:center; }
    label { font-size:12px; color:#cbd5e1; }
  </style>
</head>
<body>
  <header>
    <h1>Web Game IDE</h1>
    <div class="toolbar-right">
      <label><input type="checkbox" id="autoRun" checked> Auto-run</label>
      <button class="btn" id="run">▶ Run</button>
      <button class="btn" id="exportBtn">⬇ Export</button>
    </div>
  </header>

  <div class="tabs">
    <div class="tab active" data-tab="code">Code</div>
    <div class="tab" data-tab="preview">Preview</div>
  </div>

  <div class="panels">
    <div class="panel active" id="codePanel">
      <textarea id="codeArea">// Demo works with or WITHOUT a &lt;canvas id="game"&gt;.
// If you use a canvas, the preview scales to canvas.width/height.
// If you don't, it scales to the page content size.

// EXAMPLE A: No canvas — draw DOM elements
const root = document.getElementById('root');
if(root){
  root.innerHTML = '';
  const box = document.createElement('div');
  box.textContent = 'Hello DOM game!';
  box.style.cssText = 'width:480px;height:270px;display:grid;place-items:center;background:#1e293b;color:#fff;border:2px solid #94a3b8;font:600 18px system-ui;';
  root.appendChild(box);
}

// EXAMPLE B: Canvas — uncomment to try canvas
/*
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = 640; canvas.height = 360;
let x=10,y=10,vx=2.5,vy=2.0,size=40,h=0;
function frame(){
  ctx.fillStyle = '#11151c';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  x+=vx; y+=vy; h=(h+1)%360;
  if(x<0||x+size>canvas.width) vx*=-1;
  if(y<0||y+size>canvas.height) vy*=-1;
  ctx.fillStyle = `hsl(${h} 80% 60%)`;
  ctx.fillRect(x,y,size,size);
  requestAnimationFrame(frame);
}
frame();
*/</textarea>
    </div>

    <div class="panel" id="previewPanel">
      <div class="stage">
        <div class="stage-inner">
          <iframe id="preview" title="preview" sandbox="allow-scripts allow-pointer-lock"></iframe>
        </div>
      </div>
      <div class="console" id="consoleLog"></div>
    </div>
  </div>

  <script>
    const codeArea=document.getElementById('codeArea');
    const runBtn=document.getElementById('run');
    const autoRun=document.getElementById('autoRun');
    const exportBtn=document.getElementById('exportBtn');

    const tabs=document.querySelectorAll('.tab');
    const panels={ code:document.getElementById('codePanel'), preview:document.getElementById('previewPanel') };

    const preview=document.getElementById('preview');
    const consoleLog=document.getElementById('consoleLog');
    const stage=document.querySelector('.stage');

    let innerW=800, innerH=450; // measured content size fallback

    tabs.forEach(t=>t.addEventListener('click',()=>{
      tabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      Object.values(panels).forEach(p=>p.classList.remove('active'));
      panels[t.dataset.tab].classList.add('active');
      if(t.dataset.tab==='preview' && autoRun.checked) run();
    }));

    function scaleIframe(){
      const cw = stage.clientWidth, ch = stage.clientHeight; if(!cw||!ch) return;
      const s = Math.min(cw/innerW, ch/innerH);
      preview.style.width = innerW + 'px';
      preview.style.height = innerH + 'px';
      preview.style.transform = `scale(${s})`;
    }
    window.addEventListener('resize', scaleIframe);

    function buildDoc(js){
      // We provide BOTH a #root for DOM games and an optional #game canvas.
      // Size reporter prefers canvas if found, otherwise uses the page's scroll size via ResizeObserver.
      return `<!DOCTYPE html><html><head><meta charset='utf-8'/>
<style>
  html,body{height:100%;margin:0;background:#12151e;color:#eee}
  body{display:grid;place-items:center}
  #root{min-width:800px;min-height:450px}
  #game{background:#0f1117; box-shadow:0 10px 30px rgba(0,0,0,.5)}
</style>
</head><body>
  <div id="root"></div>
  <!-- Optional: your JS may use this if you want a canvas -->
  <canvas id="game" width="800" height="450" style="display:none"></canvas>
  <script>
    (function(){
      const push=(type,args)=> parent.postMessage({__IDE__:'console',type,msg:Array.from(args).join(' ')},'*');
      const ol=console.log, oe=console.error;
      console.log=function(){ push('log',arguments); ol.apply(console,arguments) };
      console.error=function(){ push('err',arguments); oe.apply(console,arguments) };
      window.addEventListener('error', e=> push('err',[e.message+' ('+e.filename+':'+e.lineno+')']));
      const preferCanvas = ()=>{ const g=document.getElementById('game'); if(!g) return null; const anyCanvas = g || document.querySelector('canvas'); return anyCanvas || null; };
      let target = preferCanvas();
      const report = ()=>{
        if(target){ parent.postMessage({__IDE__:'size', w: target.width||target.clientWidth||800, h: target.height||target.clientHeight||450}, '*'); }
        else { const b=document.body; const r=b.getBoundingClientRect(); parent.postMessage({__IDE__:'size', w: Math.ceil(Math.max(document.documentElement.scrollWidth, r.width)), h: Math.ceil(Math.max(document.documentElement.scrollHeight, r.height))}, '*'); }
      };
      const ro = new ResizeObserver(()=>{ target=null; report(); });
      ro.observe(document.body);
      // Also watch for canvas attribute changes
      const mo = new MutationObserver(()=>{ target = preferCanvas(); report(); });
      mo.observe(document.documentElement, { childList:true, subtree:true, attributes:true, attributeFilter:['width','height','style'] });
      report();
    })();
  <\/script>
  <script>try{
${js}
  // After user JS, try showing canvas if it was used
  const g=document.getElementById('game'); if(g && (g.width||g.height)) g.style.display='block';
  requestAnimationFrame(()=>{ parent.postMessage({__IDE__:'ping'}, '*'); });
}catch(e){console.error(e.message)}<\/script>
</body></html>`;
    }

    function clearLog(){ consoleLog.innerHTML=''; }
    function appendLog(msg, isErr=false){ const d=document.createElement('div'); d.textContent=msg; if(isErr) d.className='log-err'; consoleLog.appendChild(d); consoleLog.scrollTop=consoleLog.scrollHeight; }

    window.addEventListener('message', e=>{
      const d=e.data||{};
      if(d.__IDE__==='console') appendLog(d.msg, d.type==='err');
      if(d.__IDE__==='size' && d.w>0 && d.h>0){ innerW=d.w; innerH=d.h; scaleIframe(); }
    });

    function run(){
      clearLog();
      const js=codeArea.value;
      const doc=buildDoc(js);
      const blob=new Blob([doc],{type:'text/html'});
      const url=URL.createObjectURL(blob);
      preview.onload=()=>{ URL.revokeObjectURL(url); };
      preview.src=url;
    }

    runBtn.addEventListener('click',()=>{ document.querySelector('[data-tab="preview"]').click(); run(); });
    codeArea.addEventListener('input',()=>{ if(autoRun.checked && document.querySelector('.tab.active').dataset.tab==='preview') run(); });

    exportBtn.addEventListener('click',()=>{
      const content = buildDoc(codeArea.value);
      const blob=new Blob([content],{type:'text/html'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download='web-game.html'; a.click();
      setTimeout(()=>URL.revokeObjectURL(url),1000);
    });

    // First render & initial scale
    document.querySelector('[data-tab="preview"]').click();
    run();
  </script>
</body>
</html>
